var eterApp = angular.module("eterApp", [ "flashMod", "pascalprecht.translate"]);

eterApp.constant('RailsEnv', <%= {
  env: Rails.env,
  templates: TemplatesPaths.templates
}.to_json %>);

eterApp.factory("Rails", function(RailsEnv) {
  var exports = {};
  exports.templates = RailsEnv.templates;
  exports.env       = RailsEnv.env;

  exports.isDevelopment = function() { return Rails.env == "development" };

  return exports;
})

eterApp.factory('railsLocalesLoader', function RailsLocalesLoader($http) {
  return function(options) {
    return $http.get(options.key+".json").then(function(response) {
      return response.data;
    }, function() {
      throw(options.key);
    });
  };
});

eterApp.config(function Config($provide, $httpProvider, $translateProvider, RailsEnv) {
  $httpProvider.defaults.headers.common['X-CSRF-Token'] = angular.element(document.querySelector('meta[name=csrf-token]')).attr('content')
  $provide.factory('railsAssetsInterceptor', function RailsAssetsIntercreptor($cacheFactory) {
    return {
      request: function RailsAssetsIntercreptorRequest (config) {
        var assetUrl = RailsEnv.templates[config.url];
        if (assetUrl != null) {
          config.url = assetUrl;
        }
        return config;
      }
    };
  });
  $httpProvider.interceptors.push('railsAssetsInterceptor');

  if (RailsEnv.env != "development") {
    $provide.service("$templateCache", function($cacheFactory) {
      return $cacheFactory('templateCache', {
        maxAge: 3600000 * 24 * 7,
        storageMode: 'localStorage',
        recycleFreq: 60000
      });
    });
  }

  $translateProvider.useLoader('railsLocalesLoader');
  $translateProvider.preferredLanguage('en');
});
